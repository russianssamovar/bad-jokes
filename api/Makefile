ifneq (,$(wildcard .env))
    include .env
    export $(shell sed 's/=.*//' .env)
endif

BINARY_NAME=badJokes
DB_FILE=$(DB_CONNECTION_STRING)
CONFIG_PATH=$(CONFIG_PATH_VALUE)

all: build run

build:
	go build -o $(BINARY_NAME) .

run:
	CONFIG_PATH=$(CONFIG_PATH) ./$(BINARY_NAME)

clean:
	rm -f $(BINARY_NAME)
	rm -f $(DB_FILE)

print-env:
	echo "CONFIG_PATH=$(CONFIG_PATH)"
	echo "DB_FILE=$(DB_FILE)"
	
init-db:
	sqlite3 $(DB_FILE) <<EOF "CREATE TABLE IF NOT EXISTS users (\
	id INTEGER PRIMARY KEY AUTOINCREMENT, \
	username TEXT NOT NULL UNIQUE, \
	email TEXT NOT NULL UNIQUE, \
	password TEXT NOT NULL, \
	is_password_hashed INTEGER NOT NULL DEFAULT 1, \
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP, \
	modified_at DATETIME DEFAULT CURRENT_TIMESTAMP\
	); \
	CREATE TABLE IF NOT EXISTS jokes (\
	id INTEGER PRIMARY KEY AUTOINCREMENT, \
	body TEXT NOT NULL, \
	author_id INTEGER NOT NULL, \
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP, \
	modified_at DATETIME DEFAULT CURRENT_TIMESTAMP, \
	FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE\
	); \
	CREATE TABLE IF NOT EXISTS comments (\
	id INTEGER PRIMARY KEY AUTOINCREMENT, \
	joke_id INTEGER NOT NULL, \
	user_id INTEGER NOT NULL, \
	body TEXT NOT NULL, \
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP, \
	modified_at DATETIME DEFAULT CURRENT_TIMESTAMP, \
	FOREIGN KEY (joke_id) REFERENCES jokes(id) ON DELETE CASCADE, \
	FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE\
	); \
	CREATE TABLE IF NOT EXISTS interactions (\
	id INTEGER PRIMARY KEY AUTOINCREMENT, \
	entity_type TEXT NOT NULL CHECK(entity_type IN ('joke', 'comment')), \
	entity_id INTEGER NOT NULL, \
	user_id INTEGER NOT NULL, \
	type TEXT NOT NULL, \
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP, \
	modified_at DATETIME DEFAULT CURRENT_TIMESTAMP, \
	UNIQUE(entity_type, entity_id, user_id, type), \
	FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE\
	); \
	CREATE TABLE IF NOT EXISTS votes (\
	id INTEGER PRIMARY KEY AUTOINCREMENT, \
	entity_type TEXT NOT NULL CHECK(entity_type IN ('joke', 'comment')), \
	entity_id INTEGER NOT NULL, \
	user_id INTEGER NOT NULL, \
	vote_type TEXT NOT NULL CHECK(vote_type IN ('plus', 'minus')), \
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP, \
	modified_at DATETIME DEFAULT CURRENT_TIMESTAMP, \
	UNIQUE(entity_type, entity_id, user_id), \
	FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE\
	); \
	CREATE INDEX IF NOT EXISTS idx_users_username ON users(username); \
	CREATE INDEX IF NOT EXISTS idx_jokes_author_id ON jokes(author_id); \
	CREATE INDEX IF NOT EXISTS idx_comments_joke_id ON comments(joke_id); \
	CREATE INDEX IF NOT EXISTS idx_comments_user_id ON comments(user_id); \
	CREATE INDEX IF NOT EXISTS idx_interactions_entity ON interactions(entity_type, entity_id); \
	CREATE INDEX IF NOT EXISTS idx_interactions_user ON interactions(user_id); \
	CREATE INDEX IF NOT EXISTS idx_votes_entity ON votes(entity_type, entity_id); \
	CREATE INDEX IF NOT EXISTS idx_votes_user ON votes(user_id);"

seed-db:
	sqlite3 $(DB_FILE) "INSERT INTO users (username, email, password, is_password_hashed) VALUES \
	('user1', 'user1@example.com', '$(USER1_PASSWORD)', 0), \
	('user2', 'user2@example.com', '$(USER2_PASSWORD)', 0); \
	\
	INSERT INTO jokes (body, author_id) VALUES \
	('Акробат умер на батуте, но еще какое-то время продолжал радовать публику трюками.', 1), \
	('Какая комбинация болезней самая худшая? — Болезнь Альцгеймера и диарея. Ты бежишь, но не можешь вспомнить куда.', 1), \
	('Умиротворение — это когда наелся варенья и умер.', 1), \
	('Как насчет того, чтобы оторваться вечерком? — А ты кто такой? — Тромб.', 2), \
	('Усопшего так нахваливали в процессе похорон, что его вдова несколько раз подходила к гробу, чтобы проверить, кто там лежит.', 2), \
	('Простите, доктор, а что вы там мне выписываете? — Свидетельство о смерти!', 1), \
	('Доктор, говорят я скоро умру? Зачем меня столько лечили? — Чтобы вы не подумали, что никому не нужны.', 2), \
	('Девушка пишет Деду Морозу: «Когда я загадала найти мужика, я не имела в виду труп в парке».', 1), \
	('Кот умер год назад. Так я до сих пор замедляю шаг в коридоре, там, где он любил лежать, чтобы не споткнуться об него в темноте. — Может, пора его похоронить?', 2), \
	('Патологоанатом умер, но все равно поехал на работу.', 1), \
	('Мужчина выходит из комы. Его жена переодевается из черной одежды и раздраженно замечает: — Я действительно не могу ни в чем на тебя положиться, правда?', 2), \
	('Послала мужа за картошкой, а его сбила машина. — Ужас! И что ты теперь будешь делать? — Не знаю. Наверное, приготовлю рис.', 1), \
	('На днях моя девушка попросила меня передать ей помаду, но я случайно передал ей клей-карандаш. Она до сих пор со мной не разговаривает.', 2), \
	('Дрессировщик в цирке оказался ненастоящим. Его быстро раскусили.', 1), \
	('Как по-другому можно назвать похороны электрика? — Заземление.', 2), \
	('Есть много шуток о безработных. К сожалению, ни одна из них не работает.', 1), \
	('Работа в офисе, где нет бумажного документооборота, — это здорово, пока вам не нужно будет сходить в туалет.', 2), \
	('Я воспитывался как единственный ребенок в семье. Это очень расстраивало мою старшую сестру.', 1), \
	('Никогда не забуду последние слова деда. Он спросил: — Ты хорошо держишь лестницу?', 2), \
	('Хорошие мамы позволяют вам облизать венчики миксера. Великие мамы сначала его выключают.', 1), \
	('Сделал сайт для сирот. У него нет домашней страницы.', 2), \
	('«Дедушка, а куда ты гонишь 200 км/ч? — К бабушке, внучек. — Дедушка, она же умерла…»', 1), \
	('У семьи каннибалов умер родственник. И грустно и вкусно.', 2), \
	('Я копал яму в саду, как вдруг откопал целый сундук с золотом. Я уже было побежал домой, чтобы рассказать жене о ценной находке. Потом вспомнил, зачем я вообще копал яму.', 1), \
	('У рядового Иванова умер отец. Пришла телеграмма в часть. Полковник вызывает старшину и говорит: «Слушай, такое дело, ты скажи Иванову про отца, только как-нибудь поделикатней. — Будет сделано!»', 2), \
	('Старшина выстраивает роту и говорит: «У кого живы отцы – шаг вперед. Иванов! Ну ты-то куда прешь?»', 1), \
	('Коронавирус Covid-2019 очень хорошо передается через деньги. Вот почему он так быстро распространился по Европе, и почему его так мало в России.', 2), \
	('Если бы моя бабушка знала, сколько денег я сэкономил на её похоронах, то она бы перевернулась в канаве.', 1), \
	('Из-за сильного ветра в зоопарке дети целый день думали, что аист жив.', 2), \
	('«Бабушка, а чего ты удалилась из Одноклассников? — Одноклассники кончились.»', 1), \
	('Охотника-промысловика Сидорова, легко попадавшего со ста метров белке в глаз, загрызла стая одноглазых белок.', 2), \
	('Маленький мальчик пишет письмо Деду Морозу: «Дорогой Дедушка Мороз! Мне очень понравились те американские хлопушки, которые ты подарил мне на прошлый Новый Год. Поэтому подари мне, пожалуйста, на этот Новый Год два пальчика и глазик.»', 1), \
	('Всех трупиков патологоанатом Валера называл ласково — котиками, потому что у них носики холодные.', 2), \
	('Собрался народ на площади. Все спорят, как казнить синоптика: одни предлагают его расстрелять, другие – утопить, третьи – отрубить голову… В конце концов повесили, чтобы хоть направление ветра правильно показывал.', 1), \
	('Жена хоронит мужа и причитает: «Поцеловала бы я тебе глазки – да не видела от них ласки, поцеловала бы я тебе рученьки – да не видела от них полученьки, поцеловала бы я тебе пяточки – да ходили они на блядочки!» Поп слушал, слушал и говорит: «Женщина, у вас дети есть? — Да! Тогда целуем шишку и закрываем крышку!»', 2), \
	('Не кури, не бухай, занимайся спортом. Черви любят здоровую пищу.', 1), \
	('«Диспетчер, диспетчер, прием! Это рейс 127, мы терпим крушение! Повторяю, мы терпим крушение! — Рейс 127, прием! Понял, вычеркиваю.»', 2), \
	('Мальчик раскачивался на табуретке, упал и сломал все шесть ножек.', 1), \
	('Пациент в африканской больнице понял, что болен безнадежно, когда медперсонал перестал отгонять гиен от его кровати.', 2), \
	('Мужчина закашлялся в автобусе. Весь автобус на него смотрит. Кондуктор: «У вас коронавирус?» Мужчина: «Да нет, вы что! У меня туберкулез!» Кондуктор: «Ну, слава богу!»', 1), \
	('«А на оградку сделайте мне завитушки такие мелкие и часто. — Чтобы все помнили твой весёлый характер? — Чтобы заколебались красить…»', 2), \
	('«Что ты будешь делать, если наступит ядерная зима? — Пойду играть в снежки. — Ядерная! — Щупальцами!»', 1), \
	('Из-за плохо расчерченной трассы произошла перестрелка биатлонистов с пограничниками.', 2), \
	('«Доктор, как вы думаете, что будет после смерти? — Мы перестелим вашу койку и положим нового пациента.»', 1), \
	('Молодая пара попадает в автокатастрофу: муж отделывается легким испугом, а жена попадает в реанимацию. После долгой операции врач, взволнованный, сообщает: «Состояние тяжелое, она жива, но находится в коме… (и далее длинный рассказ, заканчивающийся шуткой: «Испугался, да? Шучу я: умерла она, умерла.»)»', 2), \
	('Никто не написал про самоубийство московского школьника, а ведь мальчик старался, вешался.', 1), \
	('Девочка Таня, гуляя по тонкому льду, обнаружила, что лед сверху ломается гораздо легче, чем снизу.', 2), \
	('Приходит мужик в публичный дом и говорит, что он хотел бы женщину. Ему отвечают: «У нас есть девочки по 100 баксов, 150$ и по 200$. Вам какую? — Но у меня только 2$. — Ну что ж, это, конечно, сложно, но мы и на ваши деньги что-нибудь найдем. У нас есть одна, правда, это бабушка, и она мертвая… — Ничего, давайте! — Ну я уже смирился с тем, что это бабушка, с тем, что она мертвая, но у нее же еще и сопли! — Вася, выноси бабку, она уже полная!', 1), \
	('Сидит мужик в роддоме, ждет, когда жена родит. Вроде бы роды закончились, по коридору идет улыбающийся врач, тащит за ногу ребенка. Мужик в шоке: «А-а-а!»; врач усмехается: «Шутка! Выкидыш.»', 2), \
	('Тук-тук. — Кто там? — Твоя смерть. — Пошла в жопу! — Так и запишем: «рак прямой кишки…»', 1), \
	('«Папа, папа, не шлепай меня!» — закричал сынишка; но папа-комиссар достал маузер и шлепнул его.', 2), \
	('Два еврея уехали из России: один в Израиль, другой в Германию. Через год они созвонились: «Изя! Ты не представляешь, как мне повезло – я живу в Хайфе, у меня свой магазинчик, а ты? — Абраша! Я живу в Мюнхене, работаю в крематории и, представляешь, СЖИГАЮ НЕМЦЕВ!!!»', 1), \
	('У семейного психолога: жена говорит – «Вчера мой муж в костюме Шрека забрался на гору человеческих трупов и, размахивая топором, безумно смеялся в небо на фоне грозы». Психолог: «Офигенно». Муж: «Я же говорил.»', 2), \
	('«Нужно избавиться от трупа! — Может просто закопаем? — Лучше растворить в кислоте. — Или инсценировать несчастный случай? — Господа депутаты, напоминаю, мы обсуждаем захоронение тела Ленина!» — Никому ещё не удавалось так ловко избавиться от трупа. Браво, Илон Маск!', 1), \
	('«Екатерина Ивановна, я хочу жениться на вашей дочери. — Только через мой труп. — Заманчиво, но два праздничных банкета я не потяну.»', 2), \
	('Психологический тест среди заключенных: им показывают фотографию пары новобрачных на фоне кладбища. Грабитель: «Брюлики хорошие, кольца ничего», Убийца: «Две новые жертвы среди трупов», Насильник: «Невеста похотливая коза», Карточный шулер: «Девять взяток – восемь крестов и марьяж…»', 1), \
	('«Доктор!? Я ведь не умру??? — Санитар, зашивайте без меня, а то мне кажется, что со мной трупы разговаривают.»', 2), \
	('«Где скачать руководство по расчленению трупов? — Тебе нечем заняться? — Как раз-таки есть, но надо найти руководство.»', 1), \
	('«Будешь выходить — труп вынеси! — Может быть мусор? — Может мусор, может сантехник, кто его знает…»', 2), \
	('Ограбление банка: у грабителя сползает маска. Он спрашивает у кассира: «Ты видел меня?» — «Да, видел. Выстрел, труп.» Из глубины зала: «Теща моя, но она сейчас дома.»', 1), \
	('Менеджера по продажам Игоря приняли на работу в морг, поскольку у него большой опыт работы с холодными клиентами.', 2), \
	('«Алло, это морг? — Нет, это баня. — А мне нужен морг. — Помылись бы сначала…»', 1), \
	('Две вещи не стареют — черный юмор и невакцинированные дети.', 2), \
	('Одна девочка так сильно боялась прыгать с парашютом, что прыгнула без него.', 1), \
	('— Мам, смотри, голубь! У тебя хлеб есть?— Без хлеба ешь!', 1), \
	('— Из студенческого общежития куда-то исчезли все кошки… Вот такие пироги.', 1), \
	('— Соседский пацан вызвал меня на бой из водяных пистолетов. Я просто пишу это сообщение, пока вода в кастрюле закипает.', 2), \
	('Мама, а почему ты говорила, что нельзя есть желтый снег? Потому что он соленый?', 1), \
	('Оленька хоть и промахнулась в тире, но взять мишку ей уже никто не мешал.', 2), \
	('Я копал яму в саду и вдруг откопал целый сундук с золотом. Я уж было побежал домой, чтобы рассказать жене о ценной находке. Потом вспомнил, зачем я копал яму.', 2), \
	('Когда я вижу вырезанные на деревьях имена влюбленных, я не нахожу это романтичным. Кошмарно, что люди ходят на свидания с ножами.', 1), \
	('— Послала своего за картошкой, а его сбила машина.— Ужас! И что ты теперь будешь делать?— Не знаю. Рис, наверное.', 2), \
	('Я самый добрый человек на свете. Если найдется кто-то добрее, я убью его и опять стану самым добрым.', 2), \
	('— Вчера рядом со мной умер один человек. Хорошо, что в автобусе были свободные места, так что я незаметно пересел.', 2), \
	('Аня вышла замуж за механика и родила шестерню.', 1), \
	('— Убийство. Мужчина, 38 лет. Его мать ударила его ножом за то, что он наступил на мокрый, только что помытый пол.— Вы задержали его мать?— Нет, пол все еще мокрый.', 2), \
	('Расстаться с тобой мне мешает сильная привязанность к батарее.', 1), \
	('— И зачем тебе топор?— Вам.— Что?— К человеку с топором обращаются на Вы.', 2), \
	('— Вчера я хотел утопить все свои проблемы! Но жена отказалась идти купаться.', 2), \
	('Любишь сарказм — люби и в лес в багажнике ездить.', 2), \
	('Если вам постоянно звонят с угрозами, не отчаивайтесь. Главное, что вас помнят, и вы кому-то нужны.', 1), \
	('— Доктор, у вас есть что-нибудь от головы?— Вот, возьмите ухо.', 1), \
	('В ходе длительных исследований было установлено, что сильнее всего сажает почки не нефильтрованное пиво, а нефильтрованный базар!', 2), \
	('— У вас есть йодистый калий?— Нет. Есть цианистый калий.— А какая разница?— На два рубля дороже.', 1), \
	('Все, что нас не убивает, делает нас льготниками.', 1), \
	('— Ты такой добрый, заботливый, участливый к людям!— Да, меня с детства учили ценить биологический материал.', 1), \
	('Если диарея застала вас врасплох, не пугайтесь — это еще больше ухудшит ситуацию.', 2), \
	('Доктор:— Сколько вам лет?Пациент:— На следующей неделе исполнится 21.Доктор:— А вы оптимист.', 2), \
	('Пациент:— Как часто люди умирают во время операции?Врач:— Только один раз.', 2), \
	('— Скажите, операцию без наркоза вы придумали?— Конечно, без наркоза, под наркозом разве что придумаешь?', 2), \
	('Слепой заходит в магазин, берет собаку-поводыря и начинает раскручивать ее над головой.— Что вы делаете?!— Да так, осматриваюсь.', 1), \
	('Беда не приходит одна. После взрыва на цементном заводе прошел дождь, и жизнь на предприятии окончательно замерла.', 2), \
	('Выходит мужик на балкон, а балкона нет.', 2), \
	('Когда ты передал смертельно больному одну почку, люди тебя обожают. Странно, что если передать пять почек, то они звонят в полицию.', 2), \
	('Обожаю гулять по болотам! Очень затягивает.', 2), \
	('Чтобы вас не разнесло, достаточно соблюдать два простых правила — не жрать на ночь и не курить возле бензоколонки.', 1), \
	('Я понял, что на улице ураган, когда мимо окна пролетела соседка, развешивавшая на балконе белье.', 2), \
	('Встречаются два мужика на том свете, один другому говорит:— Ты как умер?— Упал с 9 этажа, а ты?— Надо было смотреть, куда падаешь!', 2), \
	('Раньше я любил работать на пилораме, а потом как отрезало.', 2), \
	('Как меняется мир, когда смотришь на него сквозь линзы оптического прицела!', 1), \
	('— Какая разница между полиграфом и утюгом?— Полиграф — это детектор лжи, а утюг — детектор правды.', 2), \
	('Из записи в «Книге жалоб и предложений» супермаркета:«Товары расположены не очень удобно. Например, веревки — в хозяйственном отделе, мыло — в косметическом, табуретки вообще на другом этаже, в мебельном».', 2), \
	('Шутки про утопленников обычно не смешные, потому что лежат на поверхности.', 1), \
	('— Кот умер год назад. Так я до сих пор замедляю шаг в коридоре, там, где он любил лежать, чтобы не споткнуться об него в темноте.— Может, пора его похоронить?', 2), \
	('Акробат умер на батуте, но еще какое-то время продолжал радовать публику.', 1), \
	('Умиротворение — это когда наелся варенья и умер.', 1), \
	('У моей девушки сдохла собачка, и, чтобы взбодрить ее, я нашел и принес ей точно такую же. Она расплакалась и спросила меня: «Зачем мне две дохлые собачки?».', 2), \
	('— Не, я через балкон не полезу, у меня клаустрофобия!— Клаустрофобия — это боязнь замкнутого пространства. Где ты тут видишь замкнутое пространство?— В гробу! В гробу замкнутое пространство!', 2), \
	('Фальшивого дрессировщика в цирке быстро раскусили.', 2), \
	('Все грибы можно есть. Просто некоторые — один раз.', 1), \
	('Менеджера по продажам Игоря приняли на работу в морг, поскольку у него большой опыт работы с холодными клиентами.', 2), \
	('«Алло, это морг? — Нет, это баня. — А мне нужен морг. — Помылись бы сначала…»', 1), \
	('Морг. Вторую неделю нет «завоза». Санитары глушат спирт. Подъезжают братки на джипах: «Нашего Вована завалили, когда он к бабе на стрелку шел. Одета была не по-нашему – пиджак от Дольчегабаны, рубашка в тюльпанчик… Кидают пять тонн баксов, переоденьте братана — черный костюм, белая рубашка». Потом другая группа: «Наш Мишель от передозняка откинулся на фотосессии, одет в жуткий черный костюм, белую рубашку, черный галстук – наши не поймут». Санитары в ответ: «Ну сегодня и денёк! Головы им перешить!»', 2), \
	('Что такое доверие? Это когда каниббалы сосут друг другу.', 1); \
	\
	INSERT INTO comments (joke_id, user_id, body) VALUES \
	(1, 2, 'Это даже веселее, чем должно быть!'), \
	(2, 1, 'Очень мрачно, но смешно'), \
	(3, 2, 'Мне кажется, что это слишком жестко'), \
	(4, 1, 'Классика черного юмора!'), \
	(5, 2, 'Смех сквозь слезы'); \
	\
	INSERT INTO interactions (entity_type, entity_id, user_id, type) VALUES \
	('joke', 1, 2, 'laugh'), \
	('joke', 2, 1, 'heart'), \
	('joke', 3, 2, 'neutral'), \
	('joke', 4, 1, 'surprised'), \
	('joke', 5, 2, 'fire'), \
	('comment', 1, 1, 'thumbs_up'), \
	('comment', 2, 2, 'thumbs_down'), \
	('comment', 3, 1, 'laugh'), \
	('comment', 4, 2, 'angry'), \
	('comment', 5, 1, 'monkey'); \
	\
	INSERT INTO votes (entity_type, entity_id, user_id, vote_type) VALUES \
	('joke', 1, 1, 'plus'), \
	('joke', 2, 2, 'plus'), \
	('joke', 3, 1, 'minus'), \
	('joke', 4, 2, 'plus'), \
	('joke', 5, 1, 'minus'), \
	('comment', 1, 2, 'plus'), \
	('comment', 2, 1, 'minus'), \
	('comment', 3, 2, 'plus'), \
	('comment', 4, 1, 'minus'), \
	('comment', 5, 2, 'plus');"

setup: clean init-db seed-db build run
